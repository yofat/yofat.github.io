---
layout: default
classes: grid-page
---

{%- comment -%}
文章模板 - 投影片母片風格
只需在 _posts/ 中提供 Markdown 檔案，自動套用統一設計
{%- endcomment -%}

{% assign words = page.content | strip_html | normalize_whitespace | split: ' ' %}
{% assign reading_time = words.size | divided_by: 200 | ceil %}

<div class="grid-3col content-root">
  <!-- 左欄：HackMD 風格 TOC -->
  <aside class="toc" id="post-toc">
    <button class="toc-toggle" onclick="toggleTOC()" id="toc-toggle">
      <span id="toc-icon">☰</span> 目錄
    </button>
    <h3>大綱</h3>
    <nav id="toc">
      <!-- JavaScript 會根據文章標題自動生成 -->
    </nav>
  </aside>

  <!-- 中欄：文章內容 -->
  <div class="maincol">
    <article class="post-article" data-count-key="post:{{ page.id | replace: '/', ':' }}">
      <!-- 文章標題區 -->
      <header class="article-header">
        <h1 class="article-title">{{ page.title }}</h1>
        
        <div class="article-meta">
          <div class="meta-row">
            <span class="meta-item">
              <i>📅</i>
              <time datetime="{{ page.date | date_to_xmlschema }}">{{ page.date | date: "%Y年%m月%d日" }}</time>
            </span>
            
            <span class="meta-item">
              <i>⏱️</i>
              <span>約 {{ reading_time }} 分鐘閱讀</span>
            </span>
            
            <span class="meta-item">
              <i>👁️</i>
              <span id="view-count">載入中...</span> 次瀏覽
            </span>
          </div>
          
          {% if page.categories or page.tags %}
          <div class="meta-row">
            {% if page.categories %}
              <div class="meta-group">
                <span class="meta-label">📁 分類</span>
                {% for category in page.categories %}
                  <a href="{{ '/categories.html#' | append: category | relative_url }}" class="meta-tag category-tag">{{ category }}</a>
                {% endfor %}
              </div>
            {% endif %}
            
            {% if page.tags %}
              <div class="meta-group">
                <span class="meta-label">🏷️ 標籤</span>
                {% for tag in page.tags %}
                  <a href="{{ '/tags.html#' | append: tag | relative_url }}" class="meta-tag tag-tag">{{ tag }}</a>
                {% endfor %}
              </div>
            {% endif %}
          </div>
          {% endif %}
        </div>
        
        {% if page.description %}
        <div class="article-description">
          <p>{{ page.description }}</p>
        </div>
        {% endif %}
      </header>

      <!-- 文章內容 -->
      <div class="article-content">
        {{ content }}
      </div>

      <!-- 文章結尾資訊 -->
      <footer class="article-footer">
        <div class="article-end-line"></div>
        
        {% if page.updated %}
        <div class="updated-info">
          <small>🕐 最後更新：{{ page.updated | date: "%Y年%m月%d日" }}</small>
        </div>
        {% endif %}
        
        <div class="article-share">
          <span>覺得有幫助嗎？分享給更多人：</span>
          <div class="share-buttons">
            <a href="javascript:void(0)" onclick="copyToClipboard()" class="share-btn">📋 複製連結</a>
          </div>
        </div>
      </footer>
    </article>
  </div>

  <!-- 右欄：互動工具 -->
  <aside class="siderail">
    <!-- 閱讀進度 -->
    <div class="card">
      <div class="card-title">📊 閱讀進度</div>
      <div class="progress-container">
        <div class="progress-bar" id="reading-progress"></div>
        <span class="progress-text" id="progress-text">0%</span>
      </div>
    </div>
    
    <!-- 快速動作 -->
    <div class="card">
      <div class="card-title">⚡ 快速動作</div>
      <div class="action-buttons">
        <button class="action-btn" onclick="window.scrollTo({top: 0, behavior: 'smooth'})">⬆️ 回頂部</button>
        <button class="action-btn" onclick="copyToClipboard()">🔗 複製連結</button>
        <button class="action-btn" onclick="window.print()">🖨️ 列印</button>
      </div>
    </div>

    <!-- 相關文章（如果有分類） -->
    {% if page.categories %}
      {% assign category = page.categories.first %}
      {% assign related_posts = site.categories[category] | where_exp: "post", "post.url != page.url" | slice: 0, 3 %}
      {% if related_posts.size > 0 %}
      <div class="card">
        <div class="card-title">📂 {{ category }}相關</div>
        {% for post in related_posts %}
          <div class="related-post">
            <a href="{{ post.url | relative_url }}">{{ post.title }}</a>
            <small class="post-date muted">📅 {{ post.date | date: "%m月%d日" }}</small>
          </div>
        {% endfor %}
      </div>
      {% endif %}
    {% endif %}

    <!-- 導航連結 -->
    <div class="card">
      <div class="card-title">🧭 站內導航</div>
      <div class="pill-group">
        <a class="pill" href="{{ '/' | relative_url }}">🏠 首頁</a>
        <a class="pill" href="{{ '/categories.html' | relative_url }}">📂 分類</a>
        <a class="pill" href="{{ '/tags.html' | relative_url }}">🏷️ 標籤</a>
        <a class="pill" href="{{ '/search.html' | relative_url }}">🔍 搜尋</a>
      </div>
    </div>
  </aside>
</div>

<script>
// 文章頁面功能
document.addEventListener('DOMContentLoaded', function() {
  
  // TOC 生成功能
  function generateTOC() {
    const tocContainer = document.getElementById('toc');
    if (!tocContainer) return;
    
    const headings = document.querySelectorAll('.article-content h1, .article-content h2, .article-content h3, .article-content h4');
    if (headings.length === 0) {
      // 如果沒有標題，隱藏TOC
      const tocAside = document.getElementById('post-toc');
      if (tocAside) tocAside.style.display = 'none';
      return;
    }
    
    const tocLinks = [];
    
    headings.forEach((heading, index) => {
      // 為標題添加ID（如果沒有）
      if (!heading.id) {
        heading.id = 'heading-' + index;
      }
      
      const link = document.createElement('a');
      link.href = '#' + heading.id;
      link.textContent = heading.textContent;
      link.className = 'toc-link';
      
      // 根據標題層級設置樣式
      const level = parseInt(heading.tagName.substring(1));
      if (level > 1) {
        link.style.paddingLeft = ((level - 1) * 1) + 'rem';
        if (level > 2) {
          link.style.fontSize = '0.85em';
          link.style.opacity = '0.8';
        }
      }
      
      tocContainer.appendChild(link);
      tocLinks.push(link);
    });
    
    // TOC 點擊事件和高亮邏輯
    let isScrolling = false;
    
    tocLinks.forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        isScrolling = true;
        
        // 移除所有 active 狀態
        tocLinks.forEach(l => l.classList.remove('active'));
        link.classList.add('active');
        
        const target = document.querySelector(link.getAttribute('href'));
        if (target) {
          const targetPosition = target.getBoundingClientRect().top + window.pageYOffset - 100;
          window.scrollTo({
            top: targetPosition,
            behavior: "smooth"
          });
          history.replaceState(null, "", link.getAttribute('href'));
          
          setTimeout(() => {
            isScrolling = false;
          }, 1500);
        }
      });
    });

    // 滾動時更新活動TOC項目
    function updateActiveTOC() {
      if (isScrolling) return;
      
      let currentActive = null;
      const scrollTop = window.pageYOffset + 120;
      
      // 從後往前檢查，找到當前應該高亮的區域
      for (let i = headings.length - 1; i >= 0; i--) {
        const heading = headings[i];
        if (heading.offsetTop <= scrollTop) {
          currentActive = tocLinks[i];
          break;
        }
      }
      
      // 如果沒有找到，根據滾動位置決定
      if (!currentActive) {
        const windowHeight = window.innerHeight;
        const documentHeight = document.documentElement.scrollHeight;
        
        // 如果接近頁面底部，高亮最後一個
        if (scrollTop + windowHeight >= documentHeight - 200) {
          currentActive = tocLinks[tocLinks.length - 1];
        } else {
          // 否則高亮第一個
          currentActive = tocLinks[0];
        }
      }
      
      // 更新高亮
      tocLinks.forEach(link => link.classList.remove('active'));
      if (currentActive) {
        currentActive.classList.add('active');
      }
    }
    
    let ticking = false;
    function requestTick() {
      if (!ticking) {
        requestAnimationFrame(() => {
          updateActiveTOC();
          ticking = false;
        });
        ticking = true;
      }
    }
    
    window.addEventListener('scroll', requestTick);
    updateActiveTOC();
  }
  
  // TOC 收起/展開功能
  window.toggleTOC = function() {
    const toc = document.getElementById('post-toc');
    const icon = document.getElementById('toc-icon');
    
    if (!toc || !icon) return;
    
    if (toc.classList.contains('collapsed')) {
      toc.classList.remove('collapsed');
      icon.textContent = '☰';
    } else {
      toc.classList.add('collapsed');
      icon.textContent = '▶';
    }
  };
  
  // 響應式檢查
  function checkScreenWidth() {
    const toc = document.getElementById('post-toc');
    if (window.innerWidth < 1024 && toc) {
      toc.classList.add('collapsed');
      const icon = document.getElementById('toc-icon');
      if (icon) icon.textContent = '▶';
    }
  }
  
  // 複製連結功能
  window.copyToClipboard = function() {
    navigator.clipboard.writeText(window.location.href).then(() => {
      // 簡單的提示效果
      const btn = event.target;
      const originalText = btn.textContent;
      btn.textContent = '✅ 已複製';
      setTimeout(() => btn.textContent = originalText, 2000);
    });
  };
  
  // 初始化閱讀進度條
  function initReadingProgress() {
    const progressBar = document.getElementById('reading-progress');
    const progressText = document.getElementById('progress-text');
    
    if (!progressBar) return;
    
    function updateProgress() {
      const scrollTop = window.scrollY;
      const docHeight = document.documentElement.scrollHeight - window.innerHeight;
      const scrollPercent = Math.min(Math.round((scrollTop / docHeight) * 100), 100);
      
      progressBar.style.width = scrollPercent + '%';
      if (progressText) progressText.textContent = scrollPercent + '%';
    }
    
    // 初始化和事件監聽
    updateProgress();
    window.addEventListener('scroll', updateProgress, { passive: true });
    window.addEventListener('resize', updateProgress);
  }
  
  // 初始化所有功能
  generateTOC();
  checkScreenWidth();
  window.addEventListener('resize', checkScreenWidth);
  
  // 延遲初始化避免布局問題
  setTimeout(initReadingProgress, 100);
});
</script>

<!-- 代碼塊增強功能 -->
<script src="{{ '/assets/js/code-blocks.js' | relative_url }}"></script>
