---
layout: default
title: 搜尋
permalink: /search.html
---

<div class="search-page">
  <div class="search-header">
    <h1>🔍 搜尋文章</h1>
    <p class="search-subtitle">在所有文章中搜尋關鍵字、標籤或分類</p>
  </div>

  <div class="search-container">
    <div class="search-input-wrapper">
      <input 
        id="search-input" 
        type="search" 
        placeholder="輸入關鍵字、標題或標籤..." 
        aria-label="Search"
        autocomplete="off"
      />
      <div class="search-icon">🔍</div>
      <div id="search-clear" class="search-clear" title="清除搜尋">✕</div>
    </div>
    
    <div class="search-stats">
      <span id="search-count">輸入關鍵字開始搜尋</span>
    </div>
  </div>

  <div id="search-results" class="search-results" role="list"></div>

  <div class="search-tips">
    <h3>💡 搜尋小技巧</h3>
    <ul>
      <li>支援模糊搜尋和關鍵字匹配</li>
      <li>搜尋範圍包含標題、內容、標籤和分類</li>
      <li>使用空格分隔多個關鍵字進行組合搜尋</li>
      <li>不區分大小寫，支援中英文搜尋</li>
    </ul>
    
    <div style="margin-top: 15px; padding: 10px; background: #333; border-radius: 8px;">
      <button onclick="testSearch()" style="background: var(--pri); color: #000; border: none; padding: 8px 16px; border-radius: 6px; margin-right: 10px;">測試數據載入</button>
      <button onclick="testPythonSearch()" style="background: var(--link); color: #fff; border: none; padding: 8px 16px; border-radius: 6px;">測試 Python 搜尋</button>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', async () => {
  const input = document.getElementById('search-input');
  const results = document.getElementById('search-results');

  let data = [];
  let idx = null;
  
  try {
    const res = await fetch('{{ "/search.json" | relative_url }}');
    data = await res.json();
    
    console.log('搜尋數據載入成功:', data.length, '篇文章');
    console.log('文章列表:', data.map(d => d.title));

    idx = lunr(function () {
      this.ref('url');
      this.field('title', { boost: 10 });
      this.field('categories', { boost: 5 });
      this.field('tags', { boost: 5 });
      this.field('content');
      
      data.forEach((doc, index) => {
        console.log(`正在索引文章 ${index + 1}:`, doc.title);
        this.add(doc);
      });
    });
    
    console.log('Lunr 索引建立完成');
  } catch (error) {
    console.error('載入搜尋數據時發生錯誤:', error);
    return;
  }

  function highlightText(text, query) {
    if (!query) return text;
    const regex = new RegExp(`(${query.split(' ').join('|')})`, 'gi');
    return text.replace(regex, '<span class="search-highlight">$1</span>');
  }

  function render(items, query = '') {
    const searchCount = document.getElementById('search-count');
    results.innerHTML = '';
    results.classList.remove('search-loading');
    
    console.log('渲染搜尋結果:', items.length, '個結果');
    
    if (query && items.length > 0) {
      searchCount.textContent = `找到 ${items.length} 篇相關文章`;
    } else if (query && items.length === 0) {
      searchCount.textContent = '沒有找到相關文章';
    } else {
      searchCount.textContent = '輸入關鍵字開始搜尋';
    }
    
    // 排序結果按相關性和日期
    items.sort((a, b) => {
      // 首先按相關性分數排序
      const scoreDiff = (b.score || 1) - (a.score || 1);
      if (Math.abs(scoreDiff) > 0.1) return scoreDiff;
      
      // 相關性相似時按日期排序
      const docA = data.find(d => d.url === a.ref);
      const docB = data.find(d => d.url === b.ref);
      return new Date(docB.date) - new Date(docA.date);
    });
    
    items.forEach((item, index) => {
      const doc = data.find(d => d.url === item.ref);
      
      const article = document.createElement('article');
      article.className = 'search-result-item';
      article.style.animationDelay = `${index * 0.1}s`;
      
      const title = document.createElement('h3');
      const titleLink = document.createElement('a');
      titleLink.href = doc.url;
      titleLink.innerHTML = highlightText(doc.title, query);
      title.appendChild(titleLink);
      
      const meta = document.createElement('div');
      meta.className = 'search-meta';
      
      const date = document.createElement('span');
      date.className = 'search-date';
      date.textContent = doc.date;
      
      const categories = document.createElement('span');
      categories.className = 'search-categories';
      if (doc.categories && doc.categories.length > 0) {
        categories.innerHTML = doc.categories.map(cat => 
          `<span class="category-tag">${cat}</span>`
        ).join('');
      }
      
      const tags = document.createElement('span');
      tags.className = 'search-tags';
      if (doc.tags && doc.tags.length > 0) {
        tags.innerHTML = doc.tags.map(tag => 
          `<span class="tag-item">#${tag}</span>`
        ).join('');
      }
      
      meta.appendChild(date);
      if (categories.innerHTML) meta.appendChild(categories);
      if (tags.innerHTML) meta.appendChild(tags);
      
      const excerpt = document.createElement('p');
      excerpt.className = 'search-excerpt';
      
      // 嘗試找到包含關鍵字的段落作為摘要
      let excerptText = '';
      if (doc.content) {
        const sentences = doc.content.split(/[。.!?！？]/);
        const queryWords = query.toLowerCase().split(/\s+/);
        
        // 找到包含最多關鍵字的句子
        let bestSentence = sentences[0] || '';
        let maxMatches = 0;
        
        sentences.forEach(sentence => {
          const sentenceLower = sentence.toLowerCase();
          const matches = queryWords.filter(word => 
            sentenceLower.includes(word.toLowerCase())).length;
          
          if (matches > maxMatches) {
            maxMatches = matches;
            bestSentence = sentence;
          }
        });
        
        excerptText = bestSentence.trim();
        if (excerptText.length > 150) {
          excerptText = excerptText.substring(0, 150) + '...';
        }
        if (!excerptText) {
          excerptText = doc.content.substring(0, 150) + '...';
        }
      }
      
      excerpt.innerHTML = highlightText(excerptText, query);
      
      article.appendChild(title);
      article.appendChild(meta);
      article.appendChild(excerpt);
      
      results.appendChild(article);
    });
    
    if (query && items.length === 0) {
      const noResults = document.createElement('div');
      noResults.className = 'no-results';
      noResults.innerHTML = `
        <div class="no-results-icon">📭</div>
        <p>找不到包含「<strong>${query}</strong>」的文章</p>
        <p class="muted">試試其他關鍵字或檢查拼寫</p>
      `;
      results.appendChild(noResults);
    }
  }

  const clearBtn = document.getElementById('search-clear');
  
  function performSearch() {
    const q = input.value.trim();
    if (!q) {
      render([], '');
      clearBtn.style.display = 'none';
      return;
    }
    
    clearBtn.style.display = 'block';
    
    // 顯示載入狀態
    results.classList.add('search-loading');
    document.getElementById('search-count').textContent = '搜尋中...';
    
    // 使用 setTimeout 讓 UI 有時間更新
    setTimeout(() => {
      try {
        console.log('開始搜尋:', q);
        console.log('可用數據:', data.length, '篇文章');
        
        // 直接使用簡單搜尋確保功能正常
        const items = simpleSearch(q);
        console.log('搜尋結果:', items.length);
        
        render(items, q);
      } catch (e) {
        console.error('搜尋過程發生錯誤:', e);
        render([], q);
      }
    }, 100);
  }
  
  // 簡單的備用搜尋算法
  function simpleSearch(query) {
    console.log('執行簡單搜尋:', query);
    const results = [];
    const queryLower = query.toLowerCase().trim();
    
    if (!queryLower) {
      console.log('查詢為空');
      return [];
    }
    
    console.log('搜尋關鍵字:', queryLower);
    console.log('總文章數:', data.length);
    
    data.forEach((doc, index) => {
      let score = 0;
      const titleLower = doc.title ? doc.title.toLowerCase() : '';
      const contentLower = doc.content ? doc.content.toLowerCase() : '';
      
      console.log(`\n檢查文章 ${index + 1}: "${doc.title}"`);
      console.log('  URL:', doc.url);
      console.log('  分類:', doc.categories);
      console.log('  標籤:', doc.tags);
      
      // 標題匹配 (最高權重)
      if (titleLower.indexOf(queryLower) !== -1) {
        score += 100;
        console.log('  ✓ 標題匹配 (+100)');
      }
      
      // 分類匹配
      if (doc.categories && Array.isArray(doc.categories)) {
        for (const cat of doc.categories) {
          if (cat && cat.toLowerCase().indexOf(queryLower) !== -1) {
            score += 50;
            console.log('  ✓ 分類匹配:', cat, '(+50)');
          }
        }
      }
      
      // 標籤匹配
      if (doc.tags && Array.isArray(doc.tags)) {
        for (const tag of doc.tags) {
          if (tag && tag.toLowerCase().indexOf(queryLower) !== -1) {
            score += 50;
            console.log('  ✓ 標籤匹配:', tag, '(+50)');
          }
        }
      }
      
      // 內容匹配 (較低權重)
      if (contentLower.indexOf(queryLower) !== -1) {
        score += 10;
        console.log('  ✓ 內容匹配 (+10)');
      }
      
      if (score > 0) {
        console.log(`  → 總分: ${score}`);
        results.push({ ref: doc.url, score });
      } else {
        console.log('  → 無匹配');
      }
    });
    
    console.log('\n搜尋完成，找到', results.length, '個結果');
    return results.sort((a, b) => b.score - a.score);
  }
  
  input.addEventListener('input', performSearch);
  
  clearBtn.addEventListener('click', () => {
    input.value = '';
    input.focus();
    performSearch();
  });
  
  // 鍵盤快捷鍵
  document.addEventListener('keydown', (e) => {
    // Ctrl/Cmd + K 聚焦搜尋框
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
      e.preventDefault();
      input.focus();
    }
    
    // ESC 清除搜尋
    if (e.key === 'Escape' && document.activeElement === input) {
      input.value = '';
      performSearch();
    }
  });
  
  // 動態 placeholder
  const placeholders = [
    '搜尋文章、標籤、分類... (Ctrl+K)',
    '試試搜尋 "Python"、"Jekyll"...',
    '輸入任何關鍵字開始搜尋...',
    '搜尋技術文章和教學內容...'
  ];
  
  let placeholderIndex = 0;
  function updatePlaceholder() {
    if (!input.value && document.activeElement !== input) {
      input.placeholder = placeholders[placeholderIndex];
      placeholderIndex = (placeholderIndex + 1) % placeholders.length;
    }
  }
  
  // 每 3 秒更換 placeholder
  setInterval(updatePlaceholder, 3000);
  updatePlaceholder();
  
  // 當輸入框獲得焦點時使用標準 placeholder
  input.addEventListener('focus', () => {
    input.placeholder = '輸入關鍵字搜尋...';
  });
  
  input.addEventListener('blur', updatePlaceholder);
  
  // 初始化時隱藏清除按鈕
  clearBtn.style.display = 'none';
  
  // 頁面載入完成後自動聚焦搜尋框
  input.focus();
  
  // 全域測試函數
  window.testSearch = function() {
    console.log('=== 數據載入測試 ===');
    console.log('文章總數:', data.length);
    data.forEach((doc, i) => {
      console.log(`${i + 1}. ${doc.title}`);
      console.log(`   分類: ${JSON.stringify(doc.categories)}`);
      console.log(`   標籤: ${JSON.stringify(doc.tags)}`);
      console.log(`   內容長度: ${doc.content.length} 字元`);
      console.log('   ---');
    });
  };
  
  window.testPythonSearch = function() {
    console.log('=== Python 搜尋測試 ===');
    const testResults = simpleSearch('python');
    console.log('搜尋結果數量:', testResults.length);
    testResults.forEach((result, i) => {
      const doc = data.find(d => d.url === result.ref);
      console.log(`${i + 1}. ${doc.title} (分數: ${result.score})`);
    });
    
    // 顯示在頁面上
    input.value = 'python';
    performSearch();
  };
});
</script>
