---
layout: default
title: æœå°‹
permalink: /search.html
---

<div class="search-page">
  <div class="search-header">
    <h1>ğŸ” æœå°‹æ–‡ç« </h1>
    <p class="search-subtitle">åœ¨æ‰€æœ‰æ–‡ç« ä¸­æœå°‹é—œéµå­—ã€æ¨™ç±¤æˆ–åˆ†é¡</p>
  </div>

  <div class="search-container">
    <div class="search-input-wrapper">
      <input 
        id="search-input" 
        type="search" 
        placeholder="è¼¸å…¥é—œéµå­—ã€æ¨™é¡Œæˆ–æ¨™ç±¤..." 
        aria-label="Search"
        autocomplete="off"
      />
      <div class="search-icon">ğŸ”</div>
      <div id="search-clear" class="search-clear" title="æ¸…é™¤æœå°‹">âœ•</div>
    </div>
    
    <div class="search-stats">
      <span id="search-count">è¼¸å…¥é—œéµå­—é–‹å§‹æœå°‹</span>
    </div>
  </div>

  <div id="search-results" class="search-results" role="list"></div>

  <div class="search-tips">
    <h3>ğŸ’¡ æœå°‹å°æŠ€å·§</h3>
    <ul>
      <li>æ”¯æ´æ¨¡ç³Šæœå°‹å’Œé—œéµå­—åŒ¹é…</li>
      <li>æœå°‹ç¯„åœåŒ…å«æ¨™é¡Œã€å…§å®¹ã€æ¨™ç±¤å’Œåˆ†é¡</li>
      <li>ä½¿ç”¨ç©ºæ ¼åˆ†éš”å¤šå€‹é—œéµå­—é€²è¡Œçµ„åˆæœå°‹</li>
      <li>ä¸å€åˆ†å¤§å°å¯«ï¼Œæ”¯æ´ä¸­è‹±æ–‡æœå°‹</li>
    </ul>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', async () => {
  const input = document.getElementById('search-input');
  const results = document.getElementById('search-results');

  const res = await fetch('{{ "/search.json" | relative_url }}', { cache: 'force-cache' });
  const data = await res.json();

  const idx = lunr(function () {
    this.ref('url');
    this.field('title', { boost: 10 });      // æ¨™é¡Œæ¬Šé‡æœ€é«˜
    this.field('categories', { boost: 5 });  // åˆ†é¡æ¬Šé‡è¼ƒé«˜
    this.field('tags', { boost: 5 });        // æ¨™ç±¤æ¬Šé‡è¼ƒé«˜
    this.field('content');                    // å…§å®¹æ¬Šé‡æ­£å¸¸
    data.forEach(doc => this.add(doc));
  });

  function highlightText(text, query) {
    if (!query) return text;
    const regex = new RegExp(`(${query.split(' ').join('|')})`, 'gi');
    return text.replace(regex, '<span class="search-highlight">$1</span>');
  }

  function render(items, query = '') {
    const searchCount = document.getElementById('search-count');
    results.innerHTML = '';
    results.classList.remove('search-loading');
    
    if (query && items.length > 0) {
      searchCount.textContent = `æ‰¾åˆ° ${items.length} ç¯‡ç›¸é—œæ–‡ç« `;
    } else if (query && items.length === 0) {
      searchCount.textContent = 'æ²’æœ‰æ‰¾åˆ°ç›¸é—œæ–‡ç« ';
    } else {
      searchCount.textContent = 'è¼¸å…¥é—œéµå­—é–‹å§‹æœå°‹';
    }
    
    // æ’åºçµæœæŒ‰ç›¸é—œæ€§å’Œæ—¥æœŸ
    items.sort((a, b) => {
      // é¦–å…ˆæŒ‰ç›¸é—œæ€§åˆ†æ•¸æ’åº
      const scoreDiff = (b.score || 1) - (a.score || 1);
      if (Math.abs(scoreDiff) > 0.1) return scoreDiff;
      
      // ç›¸é—œæ€§ç›¸ä¼¼æ™‚æŒ‰æ—¥æœŸæ’åº
      const docA = data.find(d => d.url === a.ref);
      const docB = data.find(d => d.url === b.ref);
      return new Date(docB.date) - new Date(docA.date);
    });
    
    items.forEach((item, index) => {
      const doc = data.find(d => d.url === item.ref);
      
      const article = document.createElement('article');
      article.className = 'search-result-item';
      article.style.animationDelay = `${index * 0.1}s`;
      
      const title = document.createElement('h3');
      const titleLink = document.createElement('a');
      titleLink.href = doc.url;
      titleLink.innerHTML = highlightText(doc.title, query);
      title.appendChild(titleLink);
      
      const meta = document.createElement('div');
      meta.className = 'search-meta';
      
      const date = document.createElement('span');
      date.className = 'search-date';
      date.textContent = doc.date;
      
      const categories = document.createElement('span');
      categories.className = 'search-categories';
      if (doc.categories && doc.categories.length > 0) {
        categories.innerHTML = doc.categories.map(cat => 
          `<span class="category-tag">${cat}</span>`
        ).join('');
      }
      
      const tags = document.createElement('span');
      tags.className = 'search-tags';
      if (doc.tags && doc.tags.length > 0) {
        tags.innerHTML = doc.tags.map(tag => 
          `<span class="tag-item">#${tag}</span>`
        ).join('');
      }
      
      meta.appendChild(date);
      if (categories.innerHTML) meta.appendChild(categories);
      if (tags.innerHTML) meta.appendChild(tags);
      
      const excerpt = document.createElement('p');
      excerpt.className = 'search-excerpt';
      
      // å˜—è©¦æ‰¾åˆ°åŒ…å«é—œéµå­—çš„æ®µè½ä½œç‚ºæ‘˜è¦
      let excerptText = '';
      if (doc.content) {
        const sentences = doc.content.split(/[ã€‚.!?ï¼ï¼Ÿ]/);
        const queryWords = query.toLowerCase().split(/\s+/);
        
        // æ‰¾åˆ°åŒ…å«æœ€å¤šé—œéµå­—çš„å¥å­
        let bestSentence = sentences[0] || '';
        let maxMatches = 0;
        
        sentences.forEach(sentence => {
          const sentenceLower = sentence.toLowerCase();
          const matches = queryWords.filter(word => 
            sentenceLower.includes(word.toLowerCase())).length;
          
          if (matches > maxMatches) {
            maxMatches = matches;
            bestSentence = sentence;
          }
        });
        
        excerptText = bestSentence.trim();
        if (excerptText.length > 150) {
          excerptText = excerptText.substring(0, 150) + '...';
        }
        if (!excerptText) {
          excerptText = doc.content.substring(0, 150) + '...';
        }
      }
      
      excerpt.innerHTML = highlightText(excerptText, query);
      
      article.appendChild(title);
      article.appendChild(meta);
      article.appendChild(excerpt);
      
      results.appendChild(article);
    });
    
    if (query && items.length === 0) {
      const noResults = document.createElement('div');
      noResults.className = 'no-results';
      noResults.innerHTML = `
        <div class="no-results-icon">ğŸ“­</div>
        <p>æ‰¾ä¸åˆ°åŒ…å«ã€Œ<strong>${query}</strong>ã€çš„æ–‡ç« </p>
        <p class="muted">è©¦è©¦å…¶ä»–é—œéµå­—æˆ–æª¢æŸ¥æ‹¼å¯«</p>
      `;
      results.appendChild(noResults);
    }
  }

  const clearBtn = document.getElementById('search-clear');
  
  function performSearch() {
    const q = input.value.trim();
    if (!q) {
      render([], '');
      clearBtn.style.display = 'none';
      return;
    }
    
    clearBtn.style.display = 'block';
    
    // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
    results.classList.add('search-loading');
    document.getElementById('search-count').textContent = 'æœå°‹ä¸­...';
    
    // ä½¿ç”¨ setTimeout è®“ UI æœ‰æ™‚é–“æ›´æ–°
    setTimeout(() => {
      try {
        let items = [];
        
        // å˜—è©¦å¤šç¨®æœå°‹ç­–ç•¥
        const queries = buildSearchQueries(q);
        
        for (const query of queries) {
          try {
            const searchResults = idx.search(query);
            if (searchResults.length > 0) {
              items = searchResults;
              break;
            }
          } catch (e) {
            continue;
          }
        }
        
        // å¦‚æœæ²’æœ‰æ‰¾åˆ°çµæœï¼Œå˜—è©¦ç°¡å–®çš„é—œéµå­—æœå°‹
        if (items.length === 0) {
          items = simpleSearch(q);
        }
        
        render(items, q);
      } catch (e) {
        render([], q); // ç„¡æ•ˆèªæ³•ä¿è­·
      }
    }, 100);
  }
  
  // å»ºç«‹å¤šç¨®æœå°‹æŸ¥è©¢ç­–ç•¥
  function buildSearchQueries(query) {
    const queries = [];
    const cleanQuery = query.replace(/[^\w\s\u4e00-\u9fa5]/g, ' ').trim();
    
    if (!cleanQuery) return queries;
    
    // 1. å®Œæ•´åŒ¹é…
    queries.push(`"${cleanQuery}"`);
    
    // 2. æ‰€æœ‰è©éƒ½å¿…é ˆåŒ…å«
    const words = cleanQuery.split(/\s+/);
    if (words.length > 1) {
      queries.push(words.map(w => `+${w}`).join(' '));
    }
    
    // 3. ä»»ä¸€è©åŒ¹é…
    queries.push(words.join(' '));
    
    // 4. æ¨¡ç³Šæœå°‹
    queries.push(words.map(w => `${w}~1`).join(' '));
    
    // 5. è¬ç”¨å­—ç¬¦æœå°‹
    queries.push(words.map(w => `${w}*`).join(' '));
    
    return queries;
  }
  
  // ç°¡å–®çš„å‚™ç”¨æœå°‹ç®—æ³•
  function simpleSearch(query) {
    const results = [];
    const queryLower = query.toLowerCase();
    
    data.forEach(doc => {
      let score = 0;
      const titleLower = doc.title.toLowerCase();
      const contentLower = doc.content.toLowerCase();
      
      // æ¨™é¡ŒåŒ¹é…å¾—åˆ†æœ€é«˜
      if (titleLower.includes(queryLower)) score += 10;
      
      // åˆ†é¡å’Œæ¨™ç±¤åŒ¹é…
      if (doc.categories && doc.categories.some(cat => 
          cat.toLowerCase().includes(queryLower))) score += 5;
      if (doc.tags && doc.tags.some(tag => 
          tag.toLowerCase().includes(queryLower))) score += 5;
      
      // å…§å®¹åŒ¹é…
      if (contentLower.includes(queryLower)) score += 1;
      
      if (score > 0) {
        results.push({ ref: doc.url, score });
      }
    });
    
    return results.sort((a, b) => b.score - a.score);
  }
  
  input.addEventListener('input', performSearch);
  
  clearBtn.addEventListener('click', () => {
    input.value = '';
    input.focus();
    performSearch();
  });
  
  // éµç›¤å¿«æ·éµ
  document.addEventListener('keydown', (e) => {
    // Ctrl/Cmd + K èšç„¦æœå°‹æ¡†
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
      e.preventDefault();
      input.focus();
    }
    
    // ESC æ¸…é™¤æœå°‹
    if (e.key === 'Escape' && document.activeElement === input) {
      input.value = '';
      performSearch();
    }
  });
  
  // å‹•æ…‹ placeholder
  const placeholders = [
    'æœå°‹æ–‡ç« ã€æ¨™ç±¤ã€åˆ†é¡... (Ctrl+K)',
    'è©¦è©¦æœå°‹ "Python"ã€"Jekyll"...',
    'è¼¸å…¥ä»»ä½•é—œéµå­—é–‹å§‹æœå°‹...',
    'æœå°‹æŠ€è¡“æ–‡ç« å’Œæ•™å­¸å…§å®¹...'
  ];
  
  let placeholderIndex = 0;
  function updatePlaceholder() {
    if (!input.value && document.activeElement !== input) {
      input.placeholder = placeholders[placeholderIndex];
      placeholderIndex = (placeholderIndex + 1) % placeholders.length;
    }
  }
  
  // æ¯ 3 ç§’æ›´æ› placeholder
  setInterval(updatePlaceholder, 3000);
  updatePlaceholder();
  
  // ç•¶è¼¸å…¥æ¡†ç²å¾—ç„¦é»æ™‚ä½¿ç”¨æ¨™æº– placeholder
  input.addEventListener('focus', () => {
    input.placeholder = 'è¼¸å…¥é—œéµå­—æœå°‹...';
  });
  
  input.addEventListener('blur', updatePlaceholder);
  
  // åˆå§‹åŒ–æ™‚éš±è—æ¸…é™¤æŒ‰éˆ•
  clearBtn.style.display = 'none';
  
  // é é¢è¼‰å…¥å®Œæˆå¾Œè‡ªå‹•èšç„¦æœå°‹æ¡†
  input.focus();
});
</script>
