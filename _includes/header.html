<header>
  <div class="header-container">
    <a class="logo" href="{{ '/' | relative_url }}">
      <img src="{{ '/assets/image/logo_transparent.png' | relative_url }}" 
           alt="YoFat Logo" 
           class="logo-image"
           loading="lazy"
           decoding="async"
           width="40"
           height="40">
      <span class="logo-text rune-text">YOFAT</span>
    </a>
    
    <nav class="nav-container">
      <ul class="nav-menu" id="navMenu">
        <li class="nav-item">
          <a href="{{ '/' | relative_url }}" class="nav-link {% if page.url == '/' %}active{% endif %}">
            🏠 首頁
          </a>
        </li>
        <li class="nav-item">
          <a href="{{ '/posts.html' | relative_url }}" class="nav-link {% if page.url contains 'posts' %}active{% endif %}">
            📚 文章
          </a>
        </li>
        <li class="nav-item">
          <a href="{{ '/categories.html' | relative_url }}" class="nav-link {% if page.url contains 'categories' %}active{% endif %}">
            📂 分類
          </a>
        </li>
        <li class="nav-item">
          <a href="{{ '/tags.html' | relative_url }}" class="nav-link {% if page.url contains 'tags' %}active{% endif %}">
            🏷️ 標籤
          </a>
        </li>
        <li class="nav-item">
          <a href="{{ '/search.html' | relative_url }}" class="nav-link {% if page.url contains 'search' %}active{% endif %}">
            🔍 搜尋
          </a>
        </li>
      </ul>
      
      <div class="nav-actions">
        <button id="theme-toggle" class="btn secondary">
          <span id="theme-icon">🌙</span>
        </button>
        <button class="mobile-toggle" id="mobileToggle">
          <span></span>
          <span></span>
          <span></span>
        </button>
      </div>
    </nav>
  </div>
  
  <!-- 閱讀進度條 -->
    <div class="reading-progress" id="readingProgress"></div>
  </header>

  <script>
    // Emergency/robust handler: ensure mobile toggle and reading progress are bound after DOM ready.
    document.addEventListener('DOMContentLoaded', function() {
      try {
        // Mobile toggle emergency binding (won't override existing handlers but ensures functionality)
        const mobileBtn = document.getElementById('mobileToggle');
        const navMenu = document.getElementById('navMenu');
        if (mobileBtn && navMenu) {
          mobileBtn.setAttribute('aria-controls', 'navMenu');
          if (!mobileBtn.hasAttribute('aria-expanded')) mobileBtn.setAttribute('aria-expanded', 'false');

          mobileBtn.addEventListener('click', function(e) {
            e && e.preventDefault();
            const isOpen = navMenu.classList.toggle('active');
            mobileBtn.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
            document.body.classList.toggle('nav-open', isOpen);
            // inline style fallback to avoid collapsed menu due to CSS specificity issues
            try {
              const headerEl = document.querySelector('header');
              const headerH = headerEl ? Math.round(headerEl.getBoundingClientRect().height) : (parseInt(getComputedStyle(document.documentElement).getPropertyValue('--header-height')) || 56);
              if (isOpen) {
                navMenu.style.position = 'fixed';
                navMenu.style.top = headerH + 'px';
                navMenu.style.left = '0';
                navMenu.style.right = '0';
                navMenu.style.bottom = '0';
                navMenu.style.maxHeight = (window.innerHeight - headerH) + 'px';
                navMenu.style.height = (window.innerHeight - headerH) + 'px';
                navMenu.style.overflowY = 'auto';
                navMenu.style.boxSizing = 'border-box';
              } else {
                navMenu.style.position = '';
                navMenu.style.top = '';
                navMenu.style.left = '';
                navMenu.style.right = '';
                navMenu.style.bottom = '';
                navMenu.style.maxHeight = '';
                navMenu.style.height = '';
                navMenu.style.overflowY = '';
                navMenu.style.boxSizing = '';
              }
            } catch (err) {
              console.warn('mobileToggle emergency inline-style fallback error', err);
            }
            console.log('mobileToggle emergency handler toggled:', isOpen);
          }, { passive: false });

          // For debugging: log presence
          console.log('mobileToggle emergency bound', !!mobileBtn, !!navMenu);
        } else {
          console.warn('mobileToggle or navMenu not found in DOM', !!mobileBtn, !!navMenu);
        }

        // Reading progress bar
        const progress = document.getElementById('readingProgress');
        function updateReadingProgress(){
          if (!progress) return;
          const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
          const docHeight = document.documentElement.scrollHeight - window.innerHeight;
          const scrollPercent = docHeight > 0 ? (scrollTop / docHeight) * 100 : 0;
          progress.style.width = scrollPercent + '%';
        }
        window.addEventListener('scroll', updateReadingProgress, { passive: true });
        updateReadingProgress();
      } catch (err) {
        console.error('Header emergency script error', err);
      }
    });
  </script>
