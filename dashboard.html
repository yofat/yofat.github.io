---
layout: default
title: 儀表板
robots: noindex
---

<h1>儀表板</h1>

<div id="board" style="display:none">
  <section>
    <h2>總瀏覽量</h2>
    <p><strong id="total-views">…</strong></p>
    <canvas id="dailyChart" height="160"></canvas>
  </section>

  <section>
    <h2>各篇文章瀏覽數</h2>
    <table class="table">
      <thead><tr><th>文章</th><th>瀏覽數</th></tr></thead>
      <tbody id="post-rows"></tbody>
    </table>
  </section>

  <section>
    <h2>GitHub 星星</h2>
    <p>本網站 repo 星星數：<strong id="gh-stars">…</strong></p>
  </section>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // 若還存在 gate，移除並顯示 board
  document.getElementById('gate')?.remove();
  const board = document.getElementById('board');
  if (board) board.style.display = '';

  initBoard(); // 直接初始化儀表板
});

// ---- Dashboard Logic ----
// 建議用「owner/repo」當命名空間，避免跟別人撞名
const NAMESPACE = "{{ site.github_owner }}/{{ site.github_repo }}";
const TOTAL_KEY = "site:total";

// 由 Jekyll 自動把所有文章塞進來（標題、count key、url）
const POSTS = [
  {% for p in site.posts %}
    { title: {{ p.title | jsonify }}, key: "post:{{ p.id | replace: '/', ':' }}", url: "{{ p.url | relative_url }}" }{% unless forloop.last %},{% endunless %}
  {% endfor %}
];

// 讀取計數（countapi）
async function countGet(key){
  const r = await fetch(`https://api.countapi.xyz/get/${encodeURIComponent(NAMESPACE)}/${encodeURIComponent(key)}`);
  if (!r.ok) return { value: 0 };
  return r.json();
}

async function initBoard(){
  // 總瀏覽量
  const total = await countGet(TOTAL_KEY);
  const totalEl = document.getElementById('total-views');
  if (totalEl) totalEl.textContent = total.value || 0;

  // 文章列表
  const tbody = document.getElementById('post-rows');
  if (tbody) {
    tbody.innerHTML = '';
    for (const p of POSTS){
      const c = await countGet(p.key);
      const tr = document.createElement('tr');

      const td1 = document.createElement('td');
      const a = document.createElement('a');
      a.href = p.url; a.textContent = p.title;
      td1.appendChild(a);

      const td2 = document.createElement('td');
      td2.textContent = (c.value || 0);

      tr.appendChild(td1); tr.appendChild(td2); 
      tbody.appendChild(tr);
    }
  }

  // 簡易折線圖（示意）
  const ctx = document.getElementById('dailyChart');
  if (ctx && window.Chart) {
    const days = 14, base = total.value || 0;
    const labels = Array.from({length: days}, (_,i)=>`D-${days-i-1}`);
    const values = labels.map((_,i)=> Math.max(0, Math.round(base/(days*1.2) + (Math.sin(i/2)*3))));
    new Chart(ctx, {
      type: 'line',
      data: { labels, datasets: [{ label: '近兩週（示意）', data: values }] },
      options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true }}}
    });
  }

  // GitHub Stars
  const starEl = document.getElementById('gh-stars');
  if (starEl) {
    fetch(`https://api.github.com/repos/{{ site.github_owner }}/{{ site.github_repo }}`)
      .then(r=>r.json()).then(j=>{ starEl.textContent = j.stargazers_count ?? '—'; })
      .catch(()=>{ starEl.textContent = '—'; });
  }
}
</script>
