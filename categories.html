---
layout: default
title: 分類
permalink: /categories.html
classes: grid-page
---

<div class="grid-3col content-root">
  <!-- 左欄：分類導航 -->
  <aside class="toc">
    <h3>📂 分類導航</h3>
    <nav id="categories-nav">
      {% assign all_categories = site.articles | map: 'categories' | join: ',' | split: ',' | uniq | sort %}
      {% for category in all_categories %}
        {% unless category == '' %}
          {% assign posts_count = site.articles | where_exp: "post", "post.categories contains category" | size %}
          <a href="#{{ category | slugify }}" class="toc-link" data-count="{{ posts_count }}">
            <span class="category-name">{{ category }}</span>
            <span class="category-count">{{ posts_count }}</span>
          </a>
        {% endunless %}
      {% endfor %}
    </nav>
  </aside>

  <!-- 中欄：分類內容 -->
  <div class="maincol">
    <section class="section">
      <h1>📂 文章分類</h1>
      <p class="page-description">探索按主題組織的所有文章</p>
      
      {% assign all_categories = site.articles | map: 'categories' | join: ',' | split: ',' | uniq | sort %}
      {% for category in all_categories %}
        {% unless category == '' %}
          {% assign category_posts = site.articles | where_exp: "post", "post.categories contains category" %}
          {% if category_posts.size > 0 %}
            <section class="category-section" id="{{ category | slugify }}">
              <div class="category-header">
                <h2>{{ category }}</h2>
                <span class="category-count-badge">{{ category_posts.size }} 篇文章</span>
              </div>
              
              <div class="posts-grid">
                {% for post in category_posts %}
                  <article class="post-card">
                    <div class="post-card-content">
                      <h3><a href="{{ post.url | relative_url }}">{{ post.title }}</a></h3>
                      <div class="post-card-meta">
                        <span class="post-date">📅 {{ post.date | date: "%Y-%m-%d" }}</span>
                        {% if post.tags.size > 0 %}
                          <div class="post-tags">
                            {% for tag in post.tags limit:3 %}
                              <span class="tag">{{ tag }}</span>
                            {% endfor %}
                          </div>
                        {% endif %}
                      </div>
                      {% if post.excerpt %}
                        <p class="post-excerpt">{{ post.excerpt | strip_html | truncatewords: 20 }}</p>
                      {% endif %}
                    </div>
                  </article>
                {% endfor %}
              </div>
            </section>
          {% endif %}
        {% endunless %}
      {% endfor %}
    </section>
  </div>
                        </div>
                      </div>
                    </article>
                  {% endfor %}
                {% endif %}
              </div>
            </div>
          {% endfor %}
        </section>
      {% endfor %}

      <div class="back-nav">
        <a href="{{ '/' | relative_url }}" class="back-link">← 返回首頁</a>
      </div>
    </section>
  </div>

  <!-- 右欄：分類統計 -->
  <aside class="siderail">
    <div class="card">
      <div class="card-title">📊 分類統計</div>
      <div class="categories-stats">
        {% assign all_categories = site.articles | map: 'categories' | join: ',' | split: ',' | uniq %}
        {% assign categories_count = all_categories | size %}
        <div class="stat-item">
          <span class="stat-icon">📂</span>
          <span class="stat-number">{{ categories_count }}</span>
          <span class="stat-label">個分類</span>
        </div>
        
        <div class="stat-item">
          <span class="stat-icon">📝</span>
          <span class="stat-number">{{ site.articles.size }}</span>
          <span class="stat-label">篇文章</span>
        </div>
        
        {% if site.articles.size > 0 %}
          {% assign avg_per_category = site.articles.size | divided_by: categories_count %}
          <div class="stat-item">
            <span class="stat-icon">📈</span>
            <span class="stat-number">{{ avg_per_category }}</span>
            <span class="stat-label">平均文章數</span>
          </div>
        {% endif %}
      </div>
    </div>

    <div class="card">
      <div class="card-title">🔥 熱門分類</div>
      <div class="popular-categories">
        {% assign category_counts = '' | split: '' %}
        {% assign all_categories = site.articles | map: 'categories' | join: ',' | split: ',' | uniq | sort %}
        {% for category in all_categories %}
          {% unless category == '' %}
            {% assign posts_count = site.articles | where_exp: "post", "post.categories contains category" | size %}
            {% assign category_counts = category_counts | push: category | push: posts_count %}
          {% endunless %}
        {% endfor %}
        
        {% for category in all_categories limit: 6 %}
          {% unless category == '' %}
            {% assign posts_count = site.articles | where_exp: "post", "post.categories contains category" | size %}
            <a class="category-link" href="#{{ category | slugify }}">
              <span class="category-name">{{ category }}</span>
              <span class="category-badge">{{ posts_count }}</span>
            </a>
          {% endunless %}
        {% endfor %}
      </div>
    </div>

    <div class="card">
      <div class="card-title">🚀 快速導航</div>
      <div class="quick-nav">
        <a href="{{ '/posts.html' | relative_url }}" class="nav-item">
          <span class="nav-icon">📚</span>
          <span class="nav-text">所有文章</span>
        </a>
        <a href="{{ '/tags.html' | relative_url }}" class="nav-item">
          <span class="nav-icon">🏷️</span>
          <span class="nav-text">文章標籤</span>
        </a>
        <a href="{{ '/search.html' | relative_url }}" class="nav-item">
          <span class="nav-icon">🔍</span>
          <span class="nav-text">搜尋文章</span>
        </a>
      </div>
    </div>
  </aside>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // 分類頁面的 TOC 生成和統計數據
  const tocContainer = document.getElementById("toc");
  if (tocContainer) {
    const sections = document.querySelectorAll('h1[id], h2[id], h3[id]');
    const tocLinks = [];
    
    sections.forEach(section => {
      const link = document.createElement('a');
      link.href = '#' + section.id;
      link.textContent = section.textContent;
      link.className = 'toc-link';
      
      // 根據標題層級設置樣式
      if (section.tagName === 'H1') {
        link.style.fontWeight = 'bold';
      } else if (section.tagName === 'H2') {
        link.style.paddingLeft = '1rem';
      } else if (section.tagName === 'H3') {
        link.style.paddingLeft = '2rem';
        link.style.fontSize = '0.9em';
        link.style.opacity = '0.8';
      }
      
      tocContainer.appendChild(link);
      tocLinks.push(link);
    });

    // TOC 點擊事件和高亮邏輯
    let isScrolling = false;
    
    tocLinks.forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        isScrolling = true;
        
        // 移除所有 active 狀態
        tocLinks.forEach(l => l.classList.remove('active'));
        link.classList.add('active');
        
        const target = document.querySelector(link.getAttribute('href'));
        if (target) {
          const targetPosition = target.getBoundingClientRect().top + window.pageYOffset - 100;
          window.scrollTo({
            top: targetPosition,
            behavior: "smooth"
          });
          history.replaceState(null, "", link.getAttribute('href'));
          
          setTimeout(() => {
            isScrolling = false;
          }, 1500);
        }
      });
    });

    function updateActiveTOC() {
      if (isScrolling) return;
      
      let currentActive = null;
      const scrollTop = window.pageYOffset + 120;
      
      // 從後往前檢查，找到當前應該高亮的區域
      for (let i = sections.length - 1; i >= 0; i--) {
        const section = sections[i];
        if (section.offsetTop <= scrollTop) {
          currentActive = tocLinks[i];
          break;
        }
      }
      
      // 如果沒有找到，根據滾動位置決定
      if (!currentActive) {
        const windowHeight = window.innerHeight;
        const documentHeight = document.documentElement.scrollHeight;
        
        // 如果接近頁面底部，高亮最後一個
        if (scrollTop + windowHeight >= documentHeight - 200) {
          currentActive = tocLinks[tocLinks.length - 1];
        } else {
          // 否則高亮第一個
          currentActive = tocLinks[0];
        }
      }
      
      // 更新高亮
      tocLinks.forEach(link => link.classList.remove('active'));
      if (currentActive) {
        currentActive.classList.add('active');
        
        // 確保活動項目在TOC中可見
        const tocContainer = document.getElementById('toc');
        if (tocContainer && currentActive) {
          const containerRect = tocContainer.getBoundingClientRect();
          const activeRect = currentActive.getBoundingClientRect();
          
          if (activeRect.bottom > containerRect.bottom || activeRect.top < containerRect.top) {
            currentActive.scrollIntoView({ 
              behavior: 'smooth', 
              block: 'center',
              inline: 'nearest' 
            });
          }
        }
      }
    }
    
    let ticking = false;
    function requestTick() {
      if (!ticking) {
        requestAnimationFrame(() => {
          updateActiveTOC();
          ticking = false;
        });
        ticking = true;
      }
    }
    
    window.addEventListener('scroll', requestTick);
    updateActiveTOC();
  }

  // 統計數據更新 - 從實際文章數據計算
  const allArticles = document.querySelectorAll('.article-card');
  const totalArticles = allArticles.length;
  
  const categoryCount = new Map();
  allArticles.forEach(article => {
    const categoryElement = article.querySelector('.article-category');
    if (categoryElement) {
      const category = categoryElement.textContent.trim();
      categoryCount.set(category, (categoryCount.get(category) || 0) + 1);
    }
  });
  
  // 更新右欄統計數據
  const statsElement = document.querySelector('.stats-grid .stat-number');
  if (statsElement) {
    statsElement.textContent = totalArticles;
  }
  
  const categoriesStatElement = document.querySelectorAll('.stats-grid .stat-number')[1];
  if (categoriesStatElement) {
    categoriesStatElement.textContent = categoryCount.size;
  }
  
  // 更新熱門分類
  const popularCategoriesContainer = document.querySelector('.popular-categories');
  if (popularCategoriesContainer) {
    // 清空現有內容
    popularCategoriesContainer.innerHTML = '<h3>熱門分類</h3>';
    
    // 將分類按文章數量排序
    const sortedCategories = Array.from(categoryCount.entries())
      .sort((a, b) => b[1] - a[1])
      .slice(0, 5); // 只顯示前5個
    
    sortedCategories.forEach(([category, count]) => {
      const categoryLink = document.createElement('a');
      categoryLink.href = '#' + category.replace(/\s+/g, '-').toLowerCase();
      categoryLink.className = 'category-link';
      categoryLink.innerHTML = `${category} <span class="count">(${count})</span>`;
      popularCategoriesContainer.appendChild(categoryLink);
    });
  }
});

// TOC 收起/展開功能 (全域函式)
function toggleTOC() {
  const toc = document.getElementById('post-toc');
  const icon = document.getElementById('toc-icon');
  
  if (!toc || !icon) return;
  
  if (toc.classList.contains('collapsed')) {
    toc.classList.remove('collapsed');
    icon.textContent = '☰';
  } else {
    toc.classList.add('collapsed');
    icon.textContent = '▶';
  }
}

// 響應式檢查
function checkScreenWidth() {
  const toc = document.getElementById('post-toc');
  if (window.innerWidth < 1024 && toc) {
    toc.classList.add('collapsed');
    const icon = document.getElementById('toc-icon');
    if (icon) icon.textContent = '▶';
  }
}

// 初始化
document.addEventListener('DOMContentLoaded', function() {
  checkScreenWidth();
  window.addEventListener('resize', checkScreenWidth);
  
  // TOC 鏈接點擊平滑滾動
  document.querySelectorAll('#categories-toc a').forEach(link => {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      const target = document.querySelector(this.getAttribute('href'));
      if (target) {
        target.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    });
  });
});
</script>
